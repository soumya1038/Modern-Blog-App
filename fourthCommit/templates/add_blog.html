{% extends "base.html" %}

{% block title %}Add New Post - Modern Blog{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto animate-fade-in">
    <div class="text-center mb-12">
        <div class="inline-block p-6 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-3xl mb-6">
            <div class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center text-2xl text-white shadow-xl mx-auto">
                âœï¸
            </div>
        </div>
        <h1 class="text-4xl font-bold bg-gradient-to-r from-gray-900 via-indigo-900 to-purple-900 bg-clip-text text-transparent mb-4">
            Create New Post
        </h1>
        <p class="text-xl text-gray-600 max-w-2xl mx-auto">
            Write your blog post using 
            <span class="bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent font-semibold">Markdown</span> 
            for rich formatting
        </p>
    </div>

    <form method="POST" class="space-y-6">
        <div class="animate-slide-up">
            <label for="title" class="block text-sm font-semibold text-gray-700 mb-3 flex items-center">
                <span class="mr-2">ğŸ“</span> Title
            </label>
            <input type="text" 
                   id="title" 
                   name="title" 
                   required
                   class="w-full px-6 py-4 border-2 border-gray-200 rounded-2xl focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 outline-none transition-all duration-200 text-lg font-medium bg-white/70 backdrop-blur-sm hover:border-indigo-300"
                   placeholder="Enter your amazing blog post title...">
        </div>

        <div class="animate-slide-up" style="animation-delay: 0.03s">
            <label class="block text-sm font-semibold text-gray-700 mb-3 flex items-center">
                <span class="mr-2">ğŸ‘¤</span> Author
            </label>
            <div class="w-full px-6 py-4 border-2 border-gray-200 rounded-2xl bg-gray-50 text-lg font-medium text-gray-700">
                {{ session.user }}
            </div>
        </div>

        <div class="animate-slide-up" style="animation-delay: 0.05s">
            <label for="tags" class="block text-sm font-semibold text-gray-700 mb-3 flex items-center">
                <span class="mr-2">ğŸ·ï¸</span> Tags
            </label>
            <input type="text" 
                   id="tags" 
                   name="tags" 
                   class="w-full px-6 py-4 border-2 border-gray-200 rounded-2xl focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 outline-none transition-all duration-200 text-lg font-medium bg-white/70 backdrop-blur-sm hover:border-indigo-300"
                   placeholder="Enter tags separated by commas (e.g., technology, programming, web)">
        </div>

        <div class="animate-slide-up" style="animation-delay: 0.1s">
            <div class="flex items-center justify-between mb-3">
                <label for="content" class="block text-sm font-semibold text-gray-700 flex items-center">
                    <span class="mr-2">ğŸ“œ</span> Content (Markdown)
                </label>
                <div class="flex items-center space-x-4 text-sm text-gray-500">
                    <div class="flex items-center">
                        <span class="mr-1">ğŸ“Š</span>
                        <span id="wordCount">0 words</span>
                    </div>
                    <div class="flex items-center">
                        <span class="mr-1">â±ï¸</span>
                        <span id="readingTime">0 min read</span>
                    </div>
                    <div class="flex items-center">
                        <span class="mr-1">ğŸ’¾</span>
                        <span id="autoSaveStatus">Ready</span>
                    </div>
                </div>
            </div>
            
            <!-- Markdown Toolbar -->
            <div class="mb-4 p-3 bg-gray-50 rounded-xl border border-gray-200">
                <div class="flex flex-wrap gap-2">
                    <button type="button" onclick="insertMarkdown('**', '**')" class="px-3 py-1 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 text-sm font-medium" title="Bold">
                        <strong>B</strong>
                    </button>
                    <button type="button" onclick="insertMarkdown('*', '*')" class="px-3 py-1 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 text-sm font-medium italic" title="Italic">
                        I
                    </button>
                    <button type="button" onclick="insertMarkdown('`', '`')" class="px-3 py-1 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 text-sm font-mono" title="Code">
                        &lt;/&gt;
                    </button>
                    <button type="button" onclick="insertMarkdown('[', '](url)')" class="px-3 py-1 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 text-sm" title="Link">
                        ğŸ”—
                    </button>
                    <button type="button" onclick="insertMarkdown('\n## ', '')" class="px-3 py-1 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 text-sm" title="Heading">
                        H2
                    </button>
                    <button type="button" onclick="insertMarkdown('\n- ', '')" class="px-3 py-1 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 text-sm" title="List">
                        ğŸ“
                    </button>
                    <button type="button" onclick="insertMarkdown('\n> ', '')" class="px-3 py-1 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 text-sm" title="Quote">
                        ğŸ’¬
                    </button>
                    <button type="button" onclick="insertMarkdown('\n```\n', '\n```')" class="px-3 py-1 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 text-sm" title="Code Block">
                        ğŸ“‹
                    </button>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-500 font-medium">EDITOR</span>
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-red-400 rounded-full"></div>
                            <div class="w-2 h-2 bg-yellow-400 rounded-full"></div>
                            <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                        </div>
                    </div>
                    <textarea id="content" 
                              name="content" 
                              required
                              rows="24"
                              class="w-full px-6 py-4 border-2 border-gray-200 rounded-2xl focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 outline-none transition-all duration-200 font-mono text-sm bg-white/70 backdrop-blur-sm hover:border-indigo-300 resize-none"
                              placeholder="# Your Amazing Blog Post

Write your content here using **Markdown** syntax!

## Features you can use:
- **Bold text** and *italic text*
- [Links](https://example.com)
- `Code snippets`
- Lists and blockquotes
- And much more!

```python
# Code blocks
def hello_world():
    print('Hello, World!')
```

> Blockquotes for important notes

Start writing your masterpiece! âœ¨"></textarea>
                </div>
                <div class="hidden lg:block space-y-2">
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-500 font-medium">LIVE PREVIEW</span>
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-indigo-400 rounded-full animate-pulse"></div>
                            <div class="w-2 h-2 bg-purple-400 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                            <div class="w-2 h-2 bg-pink-400 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                        </div>
                    </div>
                    <div id="preview" class="w-full h-96 p-6 border-2 border-gray-200 rounded-2xl bg-gradient-to-br from-white to-gray-50 overflow-auto prose prose-sm max-w-none shadow-inner">
                        <p class="text-gray-500 italic flex items-center">
                            <span class="mr-2">âœ¨</span>
                            Start typing to see live preview...
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex gap-4 animate-slide-up" style="animation-delay: 0.2s">
            <button type="submit" 
                    class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-8 py-4 rounded-2xl hover:shadow-2xl hover:scale-105 transition-all duration-300 font-semibold text-lg flex items-center">
                <span class="mr-2">ğŸš€</span>
                Publish Post
            </button>
            <button type="button" onclick="saveToLocal()" 
                    class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-8 py-4 rounded-2xl hover:shadow-2xl hover:scale-105 transition-all duration-300 font-semibold text-lg flex items-center">
                <span class="mr-2">ğŸ’¾</span>
                Save Locally
            </button>
            <button type="button" onclick="syncLocalBlogs()" 
                    class="bg-gradient-to-r from-orange-500 to-red-600 text-white px-8 py-4 rounded-2xl hover:shadow-2xl hover:scale-105 transition-all duration-300 font-semibold text-lg flex items-center">
                <span class="mr-2">ğŸ”„</span>
                Sync Local
            </button>
            <a href="{{ url_for('index') }}" 
               class="bg-white/70 backdrop-blur-sm text-gray-700 px-8 py-4 rounded-2xl hover:bg-gray-100 transition-all duration-200 font-semibold text-lg border-2 border-gray-200 hover:border-gray-300 flex items-center">
                <span class="mr-2">â†</span>
                Cancel
            </a>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    const contentTextarea = document.getElementById('content');
    const titleInput = document.getElementById('title');
    const tagsInput = document.getElementById('tags');
    const preview = document.getElementById('preview');
    const wordCountEl = document.getElementById('wordCount');
    const readingTimeEl = document.getElementById('readingTime');
    const autoSaveStatusEl = document.getElementById('autoSaveStatus');
    
    let autoSaveTimer;
    let draftId = null;
    
    function updatePreview() {
        const markdown = contentTextarea.value;
        if (markdown.trim()) {
            preview.innerHTML = marked.parse(markdown);
        } else {
            preview.innerHTML = '<p class="text-gray-500 italic flex items-center"><span class="mr-2">âœ¨</span>Start typing to see preview...</p>';
        }
    }
    
    function updateStats() {
        const content = contentTextarea.value;
        const words = content.trim() ? content.trim().split(/\s+/).length : 0;
        const readingTime = Math.max(1, Math.ceil(words / 200));
        
        wordCountEl.textContent = `${words} words`;
        readingTimeEl.textContent = `${readingTime} min read`;
    }
    
    function autoSave() {
        const data = {
            draft_id: draftId,
            title: titleInput.value,
            author: '{{ session.user }}',
            content: contentTextarea.value,
            tags: tagsInput.value
        };
        
        if (data.title || data.content) {
            autoSaveStatusEl.textContent = 'Saving...';
            
            fetch('/autosave', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                draftId = result.draft_id;
                autoSaveStatusEl.textContent = 'Saved';
                setTimeout(() => {
                    autoSaveStatusEl.textContent = 'Ready';
                }, 2000);
            })
            .catch(() => {
                autoSaveStatusEl.textContent = 'Error';
            });
        }
    }
    
    function scheduleAutoSave() {
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(autoSave, 3000);
    }
    
    function insertMarkdown(before, after) {
        const start = contentTextarea.selectionStart;
        const end = contentTextarea.selectionEnd;
        const selectedText = contentTextarea.value.substring(start, end);
        const newText = before + selectedText + after;
        
        contentTextarea.value = contentTextarea.value.substring(0, start) + newText + contentTextarea.value.substring(end);
        contentTextarea.focus();
        contentTextarea.setSelectionRange(start + before.length, start + before.length + selectedText.length);
        
        updatePreview();
        updateStats();
        scheduleAutoSave();
    }
    
    contentTextarea.addEventListener('input', () => {
        updatePreview();
        updateStats();
        scheduleAutoSave();
    });
    
    titleInput.addEventListener('input', scheduleAutoSave);
    tagsInput.addEventListener('input', scheduleAutoSave);
    
    // Initialize
    updatePreview();
    updateStats();
    
    // Keyboard shortcuts
    contentTextarea.addEventListener('keydown', (e) => {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 'b':
                    e.preventDefault();
                    insertMarkdown('**', '**');
                    break;
                case 'i':
                    e.preventDefault();
                    insertMarkdown('*', '*');
                    break;
                case 'k':
                    e.preventDefault();
                    insertMarkdown('[', '](url)');
                    break;
            }
        }
    });
    
    // Local storage functions
    function saveToLocal() {
        if (!titleInput.value.trim() || !contentTextarea.value.trim()) {
            alert('Please fill in title and content');
            return;
        }
        
        const blogData = {
            id: titleInput.value.toLowerCase().replace(/[^a-z0-9]+/g, '-'),
            title: titleInput.value,
            author: '{{ session.user }}',
            content: contentTextarea.value,
            tags: tagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag),
            word_count: contentTextarea.value.trim().split(/\s+/).length,
            reading_time: Math.max(1, Math.ceil(contentTextarea.value.trim().split(/\s+/).length / 200)),
            created_at: new Date().toISOString(),
            local_only: true
        };
        
        let localBlogs = JSON.parse(localStorage.getItem('localBlogs') || '[]');
        const existingIndex = localBlogs.findIndex(blog => blog.id === blogData.id);
        
        if (existingIndex >= 0) {
            localBlogs[existingIndex] = blogData;
        } else {
            localBlogs.push(blogData);
        }
        
        localStorage.setItem('localBlogs', JSON.stringify(localBlogs));
        alert('Blog saved locally! You can sync it later when online.');
        updateSyncButton();
    }
    
    function syncLocalBlogs() {
        const localBlogs = JSON.parse(localStorage.getItem('localBlogs') || '[]');
        const userBlogs = localBlogs.filter(blog => blog.author === '{{ session.user }}');
        
        if (userBlogs.length === 0) {
            alert('No local blogs to sync');
            return;
        }
        
        // Show local blogs for selection
        const blogList = userBlogs.map((blog, index) => 
            `${index + 1}. ${blog.title} (${blog.created_at.split('T')[0]})`
        ).join('\n');
        
        const selection = prompt(`Select a blog to load into editor:\n\n${blogList}\n\nEnter number (1-${userBlogs.length}) or 'all' to sync all:`);
        
        if (!selection) return;
        
        if (selection.toLowerCase() === 'all') {
            // Sync all blogs to server
            fetch('/sync-blogs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ blogs: userBlogs })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Synced ${data.synced} blogs to server`);
                    const remainingBlogs = localBlogs.filter(blog => blog.author !== '{{ session.user }}');
                    localStorage.setItem('localBlogs', JSON.stringify(remainingBlogs));
                    updateSyncButton();
                } else {
                    alert('Sync failed: ' + data.message);
                }
            })
            .catch(error => {
                alert('Sync failed: Network error');
            });
        } else {
            // Load selected blog into editor
            const blogIndex = parseInt(selection) - 1;
            if (blogIndex >= 0 && blogIndex < userBlogs.length) {
                const selectedBlog = userBlogs[blogIndex];
                titleInput.value = selectedBlog.title;
                contentTextarea.value = selectedBlog.content;
                tagsInput.value = selectedBlog.tags.join(', ');
                updatePreview();
                updateStats();
                alert('Blog loaded into editor!');
            } else {
                alert('Invalid selection');
            }
        }
    }
    
    function updateSyncButton() {
        const localBlogs = JSON.parse(localStorage.getItem('localBlogs') || '[]');
        const userBlogs = localBlogs.filter(blog => blog.author === '{{ session.user }}');
        const syncBtn = document.querySelector('button[onclick="syncLocalBlogs()"]');
        if (userBlogs.length > 0) {
            syncBtn.innerHTML = `<span class="mr-2">ğŸ”„</span>Sync Local (${userBlogs.length})`;
        } else {
            syncBtn.innerHTML = `<span class="mr-2">ğŸ”„</span>Sync Local`;
        }
    }
    
    // Load local blogs count on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateSyncButton();
    });
</script>
{% endblock %}